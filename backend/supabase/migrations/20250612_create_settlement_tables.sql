-- Create merchant settlements tables and logs\n\n-- Enable UUID extension if not exists (again safe)\nCREATE EXTENSION IF NOT EXISTS "uuid-ossp";\n\n-- Main settlements aggregate table (one row per merchant)\nCREATE TABLE merchant_settlements (\n  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),\n  merchant_id UUID NOT NULL REFERENCES merchants(id) ON DELETE CASCADE,\n  mobile VARCHAR(20),\n  settled_amount NUMERIC(15,2) DEFAULT 0,\n  due_amount NUMERIC(15,2) DEFAULT 0,\n  is_deleted BOOLEAN DEFAULT FALSE,\n  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),\n  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()\n);\n\n-- Settlement payment logs (one row per payout)\nCREATE TABLE settlement_payment_logs (\n  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),\n  settlement_id UUID NOT NULL REFERENCES merchant_settlements(id) ON DELETE CASCADE,\n  amount NUMERIC(15,2) NOT NULL CHECK (amount >= 0),\n  settled_date TIMESTAMP WITH TIME ZONE DEFAULT NOW(),\n  remark TEXT,\n  is_deleted BOOLEAN DEFAULT FALSE,\n  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),\n  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()\n);\n\n-- Timestamp triggers to auto-update updated_at columns\nCREATE TRIGGER update_merchant_settlements_timestamp\nBEFORE UPDATE ON merchant_settlements\nFOR EACH ROW EXECUTE FUNCTION update_modified_column();\n\nCREATE TRIGGER update_settlement_payment_logs_timestamp\nBEFORE UPDATE ON settlement_payment_logs\nFOR EACH ROW EXECUTE FUNCTION update_modified_column();\n\n-- Enable RLS\nALTER TABLE merchant_settlements ENABLE ROW LEVEL SECURITY;\nALTER TABLE settlement_payment_logs ENABLE ROW LEVEL SECURITY;\n\n-- Policies: merchants can access own settlements\nCREATE POLICY "Merchants can access own settlement aggregate" ON merchant_settlements\n  FOR ALL USING (merchant_id = auth.uid());\n\nCREATE POLICY "Merchants can access own settlement payment logs" ON settlement_payment_logs\n  FOR ALL USING (\n    EXISTS (SELECT 1 FROM merchant_settlements s WHERE s.id = settlement_id AND s.merchant_id = auth.uid())\n  );\n\n-- Service role has unrestricted access as usual 